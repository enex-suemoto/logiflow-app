<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Logi Flow System</title>
    
    <link rel="apple-touch-icon" href="https://storage.googleapis.com/logiflow-images/icon.png">
    <link rel="icon" href="https://storage.googleapis.com/logiflow-images/icon.png">
    <style>
        /* 全画面表示の設定 */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #202124; }
        
        /* 窓（iframe）の設定 */
        iframe { 
            border: none; 
            width: 100%; 
            height: 100%; 
            display: block; 
            background-color: #fff; /* 読み込み中の白背景 */
        }
        
        /* 接続オーバーレイ */
        #connect-overlay {
            display: flex; /* 初期状態はJSで制御しますが、CSS側でもflex指定 */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
            padding: 20px; box-sizing: border-box;
        }

        .overlay-content {
            max-width: 400px;
            width: 100%;
        }

        h3 { color: #333; margin-bottom: 10px; }
        p { color: #666; font-size: 14px; margin-bottom: 30px; line-height: 1.6; }

        .btn-connect {
            width: 100%;
            padding: 16px; 
            font-size: 16px; 
            font-weight: bold;
            color: white; 
            background: #0b57d0; /* Google Blue */
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(11, 87, 208, 0.3);
            transition: transform 0.1s;
        }
        .btn-connect:active { transform: scale(0.98); }

        /* ログインできない場合の救済リンク */
        .login-help {
            margin-top: 20px;
            font-size: 12px;
        }
        .login-help a {
            color: #0b57d0;
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div id="connect-overlay">
        <div class="overlay-content">
            <h3>Logi Flow System</h3>
            <p>
                iPhone/iPadをご利用の場合、<br>
                システムを利用するには接続の許可が必要です。<br>
                下のボタンを押してください。
            </p>
            <button class="btn-connect" onclick="requestAccess()">システムに接続</button>

            <div class="login-help">
                <p>画面が真っ白になる、またはログインできない場合は<br>
                <a href="#" onclick="openDirect(); return false;">こちらから直接開く</a></p>
            </div>
        </div>
    </div>

    <iframe id="app-frame" 
            sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
    </iframe>

    <script>
        // ▼▼▼ GASのウェブアプリURL ▼▼▼
        const TARGET_GAS_URL = "https://script.google.com/macros/s/AKfycbxSQMNwzRx7PPqvQMwqYwclwlDjzP40xj3RVgKCXXw3xWPOZW7tHdrFYbCJG1ZtNaZ7Gw/exec"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const iframe = document.getElementById('app-frame');
        const overlay = document.getElementById('connect-overlay');

        // Service Workerの登録（ファイルがない場合のエラーを防ぐためtry-catchまたはコメントアウト推奨）
        // もし sw.js をGitHubに上げているならコメントアウトを外してください
        /*
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed', err));
        }
        */

        // iPhone/iPad/Mac Safari判定
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isMacSafari = navigator.vendor && navigator.vendor.indexOf('Apple') > -1 &&
                            navigator.userAgent && navigator.userAgent.indexOf('CriOS') == -1 &&
                            navigator.userAgent.indexOf('FxiOS') == -1;

        // 初期ロード判定
        // Storage Access APIが存在し、かつApple系デバイスの場合のみチェック
        if ((isIOS || isMacSafari) && document.hasStorageAccess) {
            document.hasStorageAccess().then(hasAccess => {
                if (hasAccess) {
                    // すでに許可があれば即ロード
                    overlay.style.display = 'none';
                    loadApp();
                } else {
                    // 許可がなければオーバーレイを表示したままにする
                    overlay.style.display = 'flex';
                }
            }).catch(e => {
                // エラー時は念のためオーバーレイを表示
                console.error(e);
                overlay.style.display = 'flex';
            });
        } else {
            // AndroidやPC Chromeなどはそのままロード
            overlay.style.display = 'none';
            loadApp();
        }

        // ボタンが押された時の処理
        function requestAccess() {
            if (document.requestStorageAccess) {
                document.requestStorageAccess().then(
                    () => {
                        // 成功したらオーバーレイを消してロード
                        overlay.style.display = 'none';
                        loadApp();
                    },
                    (err) => {
                        // 拒否された場合やエラーの場合
                        console.error(err);
                        alert('接続がブロックされました。設定 > Safari > サイト越えトラッキングを防ぐ をOFFにするか、下の「直接開く」リンクを試してください。');
                    }
                );
            } else {
                // API非対応の場合はそのままロード試行
                overlay.style.display = 'none';
                loadApp();
            }
        }

        // アプリ読み込み
        function loadApp() {
            // キャッシュ対策でタイムスタンプをつける場合もありますが、
            // GASのログインフローに影響する場合があるため素直に設定
            iframe.src = TARGET_GAS_URL;
        }

        // 救済措置：別タブで開く
        function openDirect() {
            window.open(TARGET_GAS_URL, '_blank');
        }
    </script>
</body>
</html>
